#!/usr/bin/env ruby

require 'json'
require 'open3'

action = ARGV[0]

mpc = %x( mpc ).lines
playing = mpc[1][/playing/] == 'playing' rescue false

case action
when /toggle/
    mpc = %x( mpc toggle ).lines
when /next/
    mpc = %x( mpc next ).lines
when /prev/
    mpc = %x( mpc prev ).lines
when /select/
    playlist = %x( mpc playlist ).lines.each_with_index.map { |song, i|
        [ song.chomp, i + 1 ]
    }
    playlist.shuffle!

    selection = []
    Open3.popen2 *%W( dmenu -p Play -nf #5ed633 -sb #265615 ) do |stdin, stdout, wait|
        stdin.puts(playlist.map(&:first))
        stdin.close

        selection = stdout.gets.chomp
        selection = playlist.find { |song, i| selection == song }
    end

    i = selection.last
    mpc = %x( mpc play #{i} ).lines
end

title = mpc[0]
progress = mpc[1][/(\d+)%/, 1].to_f / 100

text = "    #{title.chomp}    "
progress_chars = text.length * progress
text.insert(progress_chars, '%{-u}')
text.insert(0, '%{+u}')

TIME = 5
HEIGHT = 28

screen = JSON.parse(%x( bspc query -m focused -T ))['rectangle']

stdin, stdout, wait = Open3.popen2 *%W( persist bar -t #{TIME} lemonbar
    -g #{screen['width']}x#{HEIGHT}+#{screen['x']}+#{screen['y'] + screen['height'] - HEIGHT}
    -f -*-tamsyn-medium-*-*-*-16-*-*-*-*-*-*-*
    -f -*-tamsyn-bold-*-*-*-16-*-*-*-*-*-*-*
    -f -*-siji-medium-*-*-*-10-*-*-*-*-*-*-* )

stdin.puts %Q(%{c}%{B#EF101010}%{F#5ed633}%{U#5ed633}#{text}%{B-})
