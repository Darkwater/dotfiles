#!/bin/sh

# REQUIRES libnotify-id (AUR) FOR NOTIFICATIONS

api="http://status.novaember.com/image"
imageEncoding="png"
slopargs=( --nokeyboard -c 1,0.68,0 -b 1 )
maimargs=( --hidecursor )
secret=$(cat ~/.nvsecret)

eval $(slop ${slopargs[*]})
[[ "$((W+H))" = "0" ]] && exit 2

start=$(date +%s%N | cut -c 1-13)

(
    image="/tmp/screenshot.$imageEncoding"
    maim ${maimargs[*]} -g "${W}x${H}+${X}+${Y}" "$image"

    curl -F secret="$secret" -F file=@"$image" -F extension="$imageEncoding" "$api" |
        json 'return this.url' |
        tr -d '\n' | xclip

    xclip -o | xclip -selection clipboard

    end=$(date +%s%N | cut -c 1-13)
    time=$((end - start))

    notify-send -r $(cat /tmp/screentool.nid) -t 1 "Screenshot uploaded" "Took ${time}ms"

    rm /tmp/screentool.nid
) &

notify-send -pt 0 'Uploading screenshot...' > /tmp/screentool.nid
