#!/bin/zsh


api="http://status.novaember.com/image"
imageEncoding="png"
slopargs=( --nokeyboard -c 1,0.68,0 -b 1 )
maimargs=( --hidecursor )
secret=$(cat ~/.nvsecret)

eval $(slop ${slopargs[*]})
[[ "$((W+H))" = "0" ]] && exit 2

image="/tmp/screen.$imageEncoding"
maim ${maimargs[*]} -g "${W}x${H}+${X}+${Y}" "$image"

curl -# -F secret="$secret" -F file=@"$image" "$api" \
1>>(
    json 'return this.url' | \
    tr -d '\n' | xclip \
) \
2>>(
    unbuffer -p tr '\r' '\n' | \
    grep --line-buffered -oP '[[:digit:].]+(?=%)' | \
    unbuffer -p awk '
    BEGIN {
        last = 0
        actuallast = 0
        interp = 5
        delay = 0.1667 / interp
    }
    {
        delta = $0 - delta
        print "yes"
        for (i = 1; i <= interp; i++)
        {
            this = (last + delta / interp * i)
            if (actuallast < this)
            {
                printf "^r(%dx2)\n", this * 3
                system("sleep " delay "s")
                actuallast = this
            }
        }
        last = $0
    }
    ' | \
    sed -u 's/\r//g' | \
    dzen2 -ta l -w 300 -h 4 -x -312 -y -16 \
)

notify-send "Screenshot uploaded"
